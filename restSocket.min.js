!function(){function e(e){function t(e){throw"restSocket Error: "+e}function n(e){var t={originalPath:e,regexp:e},n=t.keys=[]
return e=e.replace(/([().])/g,"\\$1").replace(/(\/)?:(\w+)([\?\*])?/g,function(e,t,o,r){var s="?"===r?r:null,i="*"===r?r:null
return n.push({name:o,optional:!!s}),t=t||"",""+(s?"":t)+"(?:"+(s?t:"")+(i&&"(.+?)"||"([^/]+)")+(s||"")+")"+(s||"")}).replace(/([\/$\*])/g,"\\$1"),t.regexp=RegExp("^"+e+"$","i"),t}function o(){_.each(r.requestQueue,function(e){r.socket.send(e.resource,e.headers,e.body)}),r.requestQueue=[]}if(!("WebSocket"in window))return t("WebSockets is not supported in this browser.")
if("object"!=typeof e||"string"!=typeof e.path||"string"!=typeof e.login||"string"!=typeof e.password)return t("restSocket requires a settings object with at least a path, login, and password.")
var r=this
r.ready=!1,r.paths=[],"object"==typeof e.api&&_.each(e.api,function(e,t){var o=n(t)
o.methods=e,r.paths.push(o)}),r.handleServerRequest=function(e){_.each(r.paths,function(t){if(t.regexp.test(e.headers.subscription)){var n=e.headers.subscription.match(t.regexp),o={}
_.each(t.keys,function(e,t){n.length>t&&(o[e]=n[t+1])}),_.each(t.methods,function(t,n){n==e.headers.method&&t(e.body,o)})}})},r.openConnection=_.throttle(function(){r.socket=Stomp.client("ws://"+e.path).connect(e.login,e.password,function(){_.each(r.paths,function(e){r.socket.subscribe(e.originalPath,r.handleServerRequest)}),"function"==typeof e.onConnect&&e.onConnect(),o()},function(t){"function"==typeof e.onConnectionError&&e.onConnectionError(t)}),r.socket.debug=function(t){t.indexOf("Lost connection")>-1&&(r.ready=!1,e.autoReconnect&&r.openConnection(),"function"==typeof e.onClose&&e.onClose(event))}},2e3),r.openConnection(),r.requestQueue=[],r.handleClientRequests=function(e,n,o,s){if(!e||!n)return t("Requests require at least a resource and method.")
if(["PATCH","POST","PUT"].indexOf(n)>-1&&(!o||"object"!=typeof o))return t(n+" requests require a payload object.")
var i=e
if("GET"===n){var u="?"
"object"==typeof params&&_.each(params,function(e,t){i+=u+t+"="+e,u="&"})}var c={resource:i,headers:{method:n},body:JSON.stringify(o)}
r.ready?r.socket.send(c.resource,c.headers,c.body):(r.requestQueue.push(c),"function"==typeof s&&s())}}_.extend(e.prototype,{getPaths:function(){return this.paths},getRawSTOMP:function(){return this.socket},getReadyState:function(){return this.ready},getRequestQueue:function(){return this.requestQueue},get:function(e,t,n){this.handleClientRequests(e,"GET",t,n)},patch:function(e,t,n){this.handleClientRequests(e,"PATCH",t,n)},post:function(e,t,n){this.handleClientRequests(e,"POST",t,n)},put:function(e,t,n){this.handleClientRequests(e,"PUT",t,n)},remove:function(e,t){this.handleClientRequests(e,"DELETE",t)},mirror:function(e,t,n){this.handleServerRequest({headers:{subscription:e,method:t},body:JSON.parse(n)})}}),window.restSocket=e}()
