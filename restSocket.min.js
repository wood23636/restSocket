!function(){function e(e){for(var n,t=/\[("|')(.+)\1\]|([^.\[\]]+)/g,i=[];null!==(n=t.exec(e));)i.push(n[2]||n[3])
return i}function n(n,t){"string"==typeof t&&(t=e(t))
for(var i=-1,s=t.length;++i<s&&null!=n;)n=n[t[i]]
return i===s?n:void 0}function t(e){function t(e){throw"restSocket Error: "+e}function i(t){var i=null
try{i=JSON.parse(t.body)}finally{}var s=null
_.isString(t.headers.method)&&t.headers.method.length&&(s=t.headers.method.toUpperCase())
var o=t.headers.destination.split("/"),r=[]
_.each(o,function(e){var n=parseInt(e)
r.push(isNaN(n)||""+n!==e?"'"+e+"'":n)})
var c="["+r.slice(0,-1).join("][")+"]",a=r.slice(-1)
r="["+r.join("][")+"]"
var u=n(e.model,r),d=n(e.model,c)
if(u)s?i?"DELETE"===s?(t.body="",processSubscription(t)):"POST"===s||"PATCH"===s?(t.headers.method="",processSubscription(t)):"PUT"===s&&(_.isArray(u)&&_.isArray(i)?u=i:_.isPlainObject(u)&&_.isPlainObject(i)&&(u=i)):"DELETE"===s&&_.isPlainObject(u)&&d.splice(a,1):i&&(_.isArray(u)?_.isArray(i)||_.isPlainObject(i)&&u.push(i):_.isPlainObject(u)&&_.isPlainObject(i))
else{if(!d)return
if(i&&_.isString(t.headers.method)&&t.headers.method.length){var s=t.headers.method.toUpperCase()
_.isArray(d)&&"PUT"===s&&d.push(i)}}}function s(){_.each(r.subscriptions,function(e){r.handleClientSubscribes(e.destination,e.callback,e.headers)})}function o(){_.each(r.requestQueue,function(e){r.socket.send(e.resource,e.headers,e.body)}),r.requestQueue=[]}if(!("WebSocket"in window))return t("WebSockets is not supported in this browser.")
if("object"!=typeof e||"string"!=typeof e.path||"string"!=typeof e.login||"string"!=typeof e.password)return t("restSocket requires a settings object with at least a path, login, and password.")
var r=this
r.ready=!1,r.openConnection=_.throttle(function(){r.socket=Stomp.client("ws://"+e.path).connect(e.login,e.password,function(){"function"==typeof e.onConnect&&e.onConnect(),o(),s()},function(n){"function"==typeof e.onConnectionError&&e.onConnectionError(n)}),r.socket.debug=function(n){n.indexOf("Lost connection")>-1&&(r.ready=!1,(void 0===e.autoReconnect||e.autoReconnect)&&r.openConnection(),"function"==typeof e.onClose&&e.onClose(event))}},2e3),r.openConnection(),r.subscriptions=[],r.handleClientSubscribes=function(e,n,t){var s={}
_.isPlainObject(additionalHeaders)?s=t:_.isPlainObject(callback)&&(s=callback)
var o=function(e){var t=i
_.isFunction(n)&&(t=n),t(e)},c=r.socket.subscribe(e,o,s),a=_.uniqueId()
r.subscriptions.push({uid:a,destination:e,overrideCallback:o,headers:s})
var u=function(){this.uid=a}
return u.prototype.unsubscribe=function(){r.subscriptions.splice(_.indexOf(r.subscriptions,_.findWhere(r.subscriptions,{uid:this.uid})),1),c.unsubscribe()},u},r.requestQueue=[],r.handleClientRequests=function(e,n,i,s,o){if(!e||!n)return t("Messages require at least a destination and method.")
var c={destination:e,headers:{method:n}}
_.isPlainObject(i)&&(c.body=JSON.stringify(i)),_.isPlainObject(s)&&_.assign(c.headers,s),r.ready?r.socket.send(c.resource,c.headers,c.body):(r.requestQueue.push(c),_.isFunction(o)?o():_.isFunction(s)?s():_.isFunction(i)&&i())}}_.extend(t.prototype,{send:function(e,n,t,i,s){this.handleClientRequests(e,n,i,t,s)},subscribe:function(e,n,t){this.handleClientSubscribes(e,n,t)},get:function(e,n,t,i){this.handleClientRequests(e,"GET",{},n)
var s=this.handleClientSubscribes(e,function(e){if("PUT"!==e.headers.method)return!1
var n=JSON.parse(e.body)
t(n),s.unsubscribe()},i)},mirror:function(e,n,t){this.handleServerRequest({headers:{subscription:resource,method:n},body:JSON.parse(t)})}}),window.restSocket=t}()
