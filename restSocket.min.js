!function(){function e(e){function t(e){throw"restSocket Error: "+e}function o(e){var t={originalPath:e,regexp:e},o=t.keys=[]
return e=e.replace(/([().])/g,"\\$1").replace(/(\/)?:(\w+)([\?\*])?/g,function(e,t,n,r){var s="?"===r?r:null,u="*"===r?r:null
return o.push({name:n,optional:!!s}),t=t||"",""+(s?"":t)+"(?:"+(s?t:"")+(u&&"(.+?)"||"([^/]+)")+(s||"")+")"+(s||"")}).replace(/([\/$\*])/g,"\\$1"),t.regexp=RegExp("^"+e+"$","i"),t}function n(e){_.each($.paths,function(t){if(t.regexp.test(e.resource)){var o=e.resource.match(t.regexp),n={}
_.each(t.keys,function(e,t){o.length>t&&(n[e]=o[t+1])}),_.each(t.methods,function(t){t.method==e.method&&(e.payload&&t.success(e.payload,n),e.error&&t.error(e.error,n))})}})}function r(){_.each(a.requestQueue,function(e){a.socket.send(e)}),a.requestQueue=[]}function s(){"function"==typeof e.success&&e.success(),a.requestQueue.length>0&&r(),a.ready=!0}if(!("WebSocket"in window))return t("WebSockets is not supported in this browser.")
if(!e||!e.path)return t("You must include a path in settings.")
if(e.authToken){var u=e.authToken
if("function"==typeof u&&(u=u()),"string"!=typeof u)return t("The authToken must be a string.")}var a=this
a.ready=!1,a.openConnection=_.throttle(function(){a.socket=new WebSocket("ws://"+e.path),a.socket.onopen=function(){e.authToken?a.socket.send(e.authToken):s()},a.socket.onerror=function(){"function"==typeof e.error&&e.error()},a.socket.onmessage=function(o){var r=o.data
if(!a.ready&&e.authToken&&"string"==typeof r&&"Authentication successful"==r)s()
else{if(!(a.ready&&"object"==typeof r&&r.resource&&r.method&&(r.error||r.payload))){var u="data does not match communication pattern"
return!a.ready&&e.authToken&&(u="authorization has not completed"),t("Incoming message from server ignored because "+u+".")}if(r.payload&&"string"==typeof r.payload)try{r.payload=JSON.parse(r.payload)}catch(c){return t("Could not parse payload to JSON.")}else if("object"!=typeof r.payload)return t("Payload is not JSON or stringified JSON.")
n(r)}},a.socket.onclose=function(t){a.ready=!1,"function"==typeof e.onclose&&e.onclose(t)}},2e3),a.paths=[],"object"==typeof e.api&&_.each(e.api,function(e,t){var n=o(t)
n.methods=[],_.each(e,function(e,t){var o={method:t}
"function"==typeof e?o.success=e:"object"==typeof e&&("function"==typeof e.success&&(o.success=e.success),"function"==typeof e.error&&(o.error=e.error)),n.methods.push(o)}),a.paths.push(n)}),a.openConnection(),a.requestQueue=[],a.handleClientRequests=function(o,n,r){if(!o||!n)return t("Requests require at least a resource and method.")
if(["PATCH","POST","PUT"].indexOf(n)>-1&&(!r||"object"!=typeof r))return t(n+" requests require a payload object.")
var s=o
if("GET"===n){var u="?"
"object"==typeof params&&_.each(params,function(e,t){s+=u+t+"="+e,u="&"})}var c={resource:s,method:n};["PATCH","POST","PUT"].indexOf(n)>-1&&(c.payload=e.stringifyPayloadToServer?JSON.stringify(r):r),a.ready?a.socket.send(c):a.requestQueue.push(c)}}_.extend(e.prototype,{getPaths:function(){return this.paths},getRawSocket:function(){return this.socket},getReadyState:function(){return this.ready},getRequestQueue:function(){return this.requestQueue},reopen:function(){this.openConnection()},get:function(e,t){this.handleClientRequests(e,"GET",t)},patch:function(e,t){this.handleClientRequests(e,"PATCH",t)},post:function(e,t){this.handleClientRequests(e,"POST",t)},put:function(e,t){this.handleClientRequests(e,"PUT",t)},remove:function(e){this.handleClientRequests(e,"DELETE")}}),window.restSocket=e}()
